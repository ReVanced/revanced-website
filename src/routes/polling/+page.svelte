<script lang="ts">
	import { onMount } from 'svelte';
	import { fly } from 'svelte/transition';
	import { expoOut } from 'svelte/easing';

	import Modal from '$lib/components/atoms/Dialogue.svelte';
	import LogoOption from '$lib/components/atoms/LogoOption.svelte';
	import Button from '$lib/components/atoms/Button.svelte';

	let modalOpen = false;
	let selected: Array<string> = [];
	let logos: Array<any> = [];
	let transitionDirection = 5;
	let logoAmount = 4;
	let currentPage = 0;
	let logoPages = 1;
	let min = 0;
	let max = logoAmount;
	let token: string = '';
	let submit = false;
	$: finalPage = currentPage >= logoPages;

	// TODO: catch blocks.
	async function exchange_token(bot_token: string) {
		const response = await fetch('https://poll.revanced.app/auth/exchange', {
			method: 'POST',
			headers: {
				Authorization: `Bearer ${bot_token}`
			}
		});

		if (!response.ok) {
			throw Error(`Status Code ${response.status}: ${await response.text()}`);
		}

		const json = await response.json();

		token = json.access_token;
	}

	// you will never see shittier code tm
	// will refactor later maybe idk
	// Reply: don't think we need to refactor because nobody cares if this code is shit lol
	onMount(async () => {
		window['use_token'] = exchange_token;
		window['submit_poll'] = submitBallot;

		const response = await fetch('https://poll.revanced.app/logos');
		const json = await response.json();

		// make better json
		for (const name of Object.keys(json)) {
			logos.push({ name, ...json[name] });
		}

		// randomize the order of the logos to minimize bias
		for (let i = logos.length - 1; i > 0; i--) {
			let j = Math.floor(Math.random() * i);
			let k = logos[i];
			logos[i] = logos[j];
			logos[j] = k;
		}

		// min is the lowest index of the logos on a page, max is the highest index
		// max will be determined based on min and the amount of logos we want on each page (4)
		min = currentPage * logoAmount;
		max = min + logoAmount;

		logoPages = Math.floor(logos.length / logoAmount);
		// update ui
		logos = logos;

		if (location.hash !== '') {
			try {
				await exchange_token(location.hash.substring(1));
			} catch (err) {
				alert(`Could not exchange the token: ${err}`);
			}
		} else {
			alert('Warning: No token!');
		}
	});

	function previousPage() {
		if (currentPage <= 0) return null;
		currentPage--;
		submit = false;

		min = currentPage * logoAmount;
		max = min + logoAmount;
		transitionDirection = -5;
	}

	function nextPage() {
		if (currentPage >= logoPages || submit) return null;
		currentPage++;

		min = currentPage * logoAmount;
		max = min + logoAmount;
		transitionDirection = 5;
	}

	function clearLogos() {
		if (submit) {
			return;
		}
		selected = [];
	}

	async function submitBallot() {
		// console.log(token);
		const data = {
			votes: logos.map((logo) => ({ cid: logo.id, vote: selected.includes(logo.id) }))
		};
		console.log(data);

		const response = await fetch('https://poll.revanced.app/ballot', {
			method: 'POST',
			headers: {
				Authorization: `Bearer ${token}`,
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		});
		if (!response.ok) {
			throw Error(`Status Code ${response.status}: ${await response.text()}`);
		}
		const json = await response.json();

		if (!json.cast) {
			throw Error('Vote not cast.');
		}
	}
</script>

<svelte:head>
	<title>ReVanced 路 Logo Poll</title>
	<meta content="ReVanced 路 Logo Poll" name="og:title" />
	<meta content="ReVanced 路 Logo Poll" name="twitter:title" />
</svelte:head>

<main>
	<div class="wrapper">
		<div class="top-container">
			<h3>ReVanced</h3>
			<h1>{finalPage ? 'Review selected logos' : 'Select logos'}</h1>
			<h2>
				{selected.length}/{logos.length} selected 路 Page {Number(currentPage) + 1}/{logoPages + 1}
			</h2>
			<div class="top-custom-button-container">
				<button on:click={() => (modalOpen = !modalOpen)}>How does this work?</button>
				<button on:click={clearLogos}>Clear All</button>
			</div>
		</div>

		<div class="options-grid">
			{#each logos.slice(min, max) as { id, gdrive_direct_url, name, filename }}
				{#key currentPage}
					<span in:fly={{ x: transitionDirection, easing: expoOut, duration: 1000 }}>
						<LogoOption
							bind:selected
							clicked={selected.includes(id)}
							{id}
							logo={gdrive_direct_url}
							{name}
							{filename}
						/>
					</span>
				{/key}
			{/each}

			{#if finalPage}
				{#each logos as { id, gdrive_direct_url, name, filename }}
					{#if selected.includes(id)}
						<span in:fly={{ x: transitionDirection, easing: expoOut, duration: 1000 }}>
							<LogoOption
								bind:selected
								clicked={selected.includes(id)}
								{id}
								logo={gdrive_direct_url}
								{name}
								{filename}
							/>
						</span>
					{/if}
				{/each}
			{/if}
		</div>

		{#if finalPage && !selected.length}
			<div class="warning" in:fly={{ x: transitionDirection, easing: expoOut, duration: 1000 }}>
				<h6>No logos have been selected.</h6>
			</div>
		{/if}

		{#if submit}
			<div style="text-align: center;">
				{#await submitBallot()}
					<h6 in:fly={{ x: transitionDirection, easing: expoOut, duration: 1000 }}>
						Submitting...
					</h6>
				{:then _}
					<h6 in:fly={{ x: transitionDirection, easing: expoOut, duration: 1000 }}>
						Your vote has been cast.
					</h6>
				{:catch err}
					<h6 in:fly={{ x: transitionDirection, easing: expoOut, duration: 1000 }}>
						An error occured. Try again later.
						<br />
						{err}
					</h6>
				{/await}
			</div>
		{/if}
	</div>
	<div class="buttons-container">
		<Button on:click={previousPage} unclickable={currentPage <= 0}>Previous</Button>
		<Button
			kind="primary"
			on:click={finalPage ? () => (submit = true) : nextPage}
			unclickable={submit}
		>
			{finalPage ? 'Submit' : 'Next'}
		</Button>
	</div>
</main>

<Modal bind:modalOpen>
	<svelte:fragment slot="title">How does this work?</svelte:fragment>
	<svelte:fragment slot="description"
		>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut
		labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco
		laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in
		voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat
		non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</svelte:fragment
	>
	<div class="buttons">
		<Button
			on:click={() => {
				modalOpen = false;
			}}>Understood</Button
		>
	</div>
</Modal>

<style>
	.options-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
		flex-direction: column;
		gap: 1rem;
		margin-bottom: 3rem;
	}

	h1 {
		font-size: 2rem;
		color: var(--white);
	}

	h2 {
		font-size: 1.25rem;
		color: var(--white);
	}

	h3 {
		color: var(--white);
		margin-bottom: -0.5rem;
	}

	.buttons-container {
		display: flex;
		gap: 1rem;
		justify-content: right;
		width: 100%;
		z-index: 999;
		position: fixed;
		bottom: 0;
		right: 0;
		background-color: var(--grey-six);
		padding: 1rem 1.5rem;
		border-top: 1px solid var(--grey-three);
	}

	.buttons {
		display: flex;
		justify-content: flex-end;
	}

	@media screen and (orientation: landscape) and (min-width: 1500px) and (min-height: 950px) {
		.buttons-container {
			justify-content: center;
			z-index: unset;
			position: unset;
			bottom: unset;
			right: unset;
			border-top: none;
			background-color: transparent;
		}

		:global(.wrapper) {
			padding-bottom: 0;
		}
	}

	button {
		background-color: transparent;
		border: none;
		border: 1px solid #9E8C90;
		color: #ECE0E1;
		padding: 0.5rem 1.25rem;
		border-radius: 8px;
		cursor: pointer;
		font-weight: 500;
	}

	.top-container {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		margin-bottom: 2rem;
		background-color: var(--accent-color);
		padding: 2rem;
		border-radius: 20px;
	}

	.top-custom-button-container {
		margin-top: 0.5rem;
		display: flex;
		flex-direction: row;
		gap: 0.5rem;
	}

	.warning {
		display: flex;
		justify-content: center;
	}

	@media screen and (max-width: 768px) {
		h1 {
			font-size: 1.75rem;
		}
		.options-grid {
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
		}
	}
</style>
